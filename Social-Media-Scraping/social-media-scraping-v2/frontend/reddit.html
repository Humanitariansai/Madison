<!DOCTYPE html>
<html lang="en" data-api-base="https://madison-2-backend-v2.onrender.com">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reddit Signals Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Sora:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="ambient"></div>
  <main class="shell">
    <header class="hero">
      <p class="eyebrow">Reddit only ¬∑ FastAPI + reddit_scraper.py</p>
      <h1>Reddit Signals Dashboard</h1>
      <p class="lede">Search Reddit for any brand or idea, filter the noise, and read clean, ranked results powered by your local scraper backend.</p>
      <div class="hero-tabs">
        <button id="tab-search" class="tab active">Search Live</button>
        <button id="tab-db" class="tab">View Database</button>
      </div>
    </header>

    <section id="view-search" class="view active">
    <section class="panel-grid">
      <section class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Search controls</p>
            <h2>Run a Reddit query</h2>
          </div>
          <div id="status-chip" class="chip">Idle</div>
        </div>

        <form id="search-form" class="form">
          <div class="field">
            <label for="query">Keyword or brand</label>
            <input id="query" name="query" type="text" placeholder="e.g., apple vision pro" required>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="limit">Post count</label>
              <input id="limit" name="limit" type="number" min="5" max="100" value="30">
            </div>
            <div class="field">
              <label for="min_upvotes">Minimum score</label>
              <input id="min_upvotes" name="min_upvotes" type="number" min="0" value="0">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="time_filter">Time window</label>
              <select id="time_filter" name="time_filter">
                <option value="week">Past week</option>
                <option value="month">Past month</option>
                <option value="year">Past year</option>
                <option value="all">All time</option>
                <option value="custom">Custom range</option>
              </select>
            </div>
            <div class="field">
              <label for="regions">Regions</label>
              <select id="regions" name="regions" multiple>
                <option value="All" selected>All (no regional filter)</option>
                <option value="North America">North America</option>
                <option value="Europe">Europe</option>
                <option value="Asia">Asia</option>
                <option value="Oceania">Oceania</option>
                <option value="South America">South America</option>
                <option value="Africa">Africa</option>
              </select>
              <small class="hint">Hold Cmd/Ctrl to pick multiple regions. Choose All for full coverage.</small>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="include_subs">Include subreddits</label>
              <input id="include_subs" name="include_subs" type="text" placeholder="askreddit, technology">
              <small class="hint">Comma separated. Leave empty for any.</small>
            </div>
            <div class="field">
              <label for="exclude_subs">Exclude subreddits</label>
              <input id="exclude_subs" name="exclude_subs" type="text" placeholder="politics, worldnews">
              <small class="hint">Comma separated subreddits to skip.</small>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="sort">Sort by</label>
              <select id="sort" name="sort">
                <option value="relevance" selected>Relevance (default)</option>
                <option value="score">Score (top)</option>
                <option value="comments">Comments</option>
                <option value="new">Newest</option>
              </select>
            </div>
            <div class="field">
              <label>Match scope</label>
              <div class="pill-row">
                <label class="pill">
                  <input type="radio" name="search_scope" value="title_body" checked> Title + body
                </label>
                <label class="pill">
                  <input type="radio" name="search_scope" value="title"> Title only
                </label>
              </div>
            </div>
          </div>

          <div id="custom-dates" class="field-row is-disabled" aria-hidden="true">
            <div class="field">
              <label for="start_date">Start date</label>
              <input id="start_date" name="start_date" type="date" disabled>
            </div>
            <div class="field">
              <label for="end_date">End date</label>
              <input id="end_date" name="end_date" type="date" disabled>
            </div>
          </div>

          <input id="api_base" name="api_base" type="hidden" value="">

          <button class="btn" type="submit">Run Reddit search</button>
          <p id="feedback" class="feedback" role="status"></p>
        </form>
      </section>

      <section class="panel info">
        <p class="eyebrow">Status</p>
        <h2 id="results-title">No search yet</h2>
        <p id="results-subtitle" class="lede">Pick a brand and hit the button to pull in Reddit chatter.</p>
        <div class="stat-grid">
          <div class="stat">
            <p class="stat-label">Posts returned</p>
            <p id="stat-count" class="stat-value">0</p>
          </div>
          <div class="stat">
            <p class="stat-label">Avg score</p>
            <p id="stat-score" class="stat-value">0</p>
          </div>
          <div class="stat">
            <p class="stat-label">Avg upvote %</p>
            <p id="stat-upvote" class="stat-value">0%</p>
          </div>
        </div>
      </section>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">Results</p>
          <h2>Latest pull</h2>
        </div>
        <div class="panel-actions">
          <div id="results-count" class="chip accent">0 posts</div>
          <button id="download-btn" type="button" class="btn download" disabled>‚¨áÔ∏è Download CSV</button>
          <button id="save-btn" type="button" class="btn" disabled>üíæ Save to DB</button>
        </div>
      </div>
      <div id="results-table" class="results-table">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Subreddit</th>
                <th>Title</th>
                <th>Body</th>
                <th>Score</th>
                <th>Comments</th>
                <th>Upvote %</th>
                <th>Author</th>
                <th>Date</th>
                <th>Link</th>
              </tr>
            </thead>
            <tbody id="results-table-body">
              <tr><td colspan="9" class="empty-row">Waiting for your first search.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <p id="save-status" class="feedback"></p>
    </section>
    </section>

    <section id="view-db" class="view">
      <section class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Database filters</p>
            <h2>View saved posts</h2>
          </div>
        </div>
        <form id="db-form" class="form">
          <div class="field-row">
            <div class="field">
              <label for="db-brand">Brand/Keyword</label>
              <input id="db-brand" name="db-brand" type="text" placeholder="e.g., Apple">
            </div>
            <div class="field">
              <label for="db-subreddit">Subreddit</label>
              <input id="db-subreddit" name="db-subreddit" type="text" placeholder="e.g., technology">
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label for="db-limit">Post count</label>
              <input id="db-limit" name="db-limit" type="number" min="5" max="200" value="50">
            </div>
            <div class="field">
              <label for="db-min-score">Minimum score</label>
              <input id="db-min-score" name="db-min-score" type="number" min="0" value="0">
            </div>
          </div>
          <div class="field-row">
            <button class="btn" type="submit">Load from Database</button>
            <button id="db-view-all-btn" type="button" class="btn secondary">View All Posts</button>
          </div>
          <p id="db-feedback" class="feedback" role="status"></p>
        </form>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <p class="eyebrow">Database results</p>
            <h2>Saved posts</h2>
          </div>
          <div class="panel-actions">
            <div id="db-results-count" class="chip accent">0 posts</div>
            <button id="db-download-btn" type="button" class="btn download" disabled>‚¨áÔ∏è Download CSV</button>
          </div>
        </div>
        <div id="db-results-table" class="results-table">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Subreddit</th>
                  <th>Title</th>
                  <th>Body</th>
                  <th>Score</th>
                  <th>Comments</th>
                  <th>Upvote %</th>
                  <th>Author</th>
                  <th>Date</th>
                  <th>Link</th>
                </tr>
              </thead>
              <tbody id="db-table-body">
              <tbody id="results-table-body">
                <tr><td colspan="9" class="empty-row">Use filters above to load saved posts.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </section>
  </main>

  <div id="save-modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <p class="eyebrow">Save complete</p>
          <h3>Posts stored</h3>
        </div>
        <button id="modal-close" type="button" class="btn secondary">Close</button>
      </div>
      <div class="modal-stats">
        <div class="stat">
          <p class="stat-label">Saved</p>
          <p id="modal-saved" class="stat-value">0</p>
        </div>
        <div class="stat">
          <p class="stat-label">Duplicates</p>
          <p id="modal-dupes" class="stat-value">0</p>
        </div>
        <div class="stat">
          <p class="stat-label">Errors</p>
          <p id="modal-errors" class="stat-value">0</p>
        </div>
      </div>
      <p class="lede" id="modal-detail"></p>
    </div>
  </div>

  <script>
    const form = document.getElementById('search-form');
    const timeFilter = document.getElementById('time_filter');
    const customDates = document.getElementById('custom-dates');
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');
    const feedback = document.getElementById('feedback');
    const statusChip = document.getElementById('status-chip');
    const resultsTitle = document.getElementById('results-title');
    const resultsSubtitle = document.getElementById('results-subtitle');
    const statCount = document.getElementById('stat-count');
    const statScore = document.getElementById('stat-score');
    const statUpvote = document.getElementById('stat-upvote');
    const resultsCount = document.getElementById('results-count');
    const resultsTable = document.getElementById('results-table');
    const resultsTableBody = document.getElementById('results-table-body');
    const apiBaseInput = document.getElementById('api_base');
    const downloadBtn = document.getElementById('download-btn');
    const saveBtn = document.getElementById('save-btn');
    const saveStatus = document.getElementById('save-status');
    const modal = document.getElementById('save-modal');
    const modalClose = document.getElementById('modal-close');
    const modalSaved = document.getElementById('modal-saved');
    const modalDupes = document.getElementById('modal-dupes');
    const modalErrors = document.getElementById('modal-errors');
    const modalDetail = document.getElementById('modal-detail');

    const tabSearch = document.getElementById('tab-search');
    const tabDb = document.getElementById('tab-db');
    const viewSearch = document.getElementById('view-search');
    const viewDb = document.getElementById('view-db');
    const dbForm = document.getElementById('db-form');
    const dbFeedback = document.getElementById('db-feedback');
    const dbResultsCount = document.getElementById('db-results-count');
    const dbResultsTable = document.getElementById('db-results-table');
    const dbTableBody = document.getElementById('db-table-body');
    const dbDownloadBtn = document.getElementById('db-download-btn');
    const dbViewAllBtn = document.getElementById('db-view-all-btn');

    let lastPosts = [];
    let lastBrand = '';
    let apiBaseCurrent = '';
    let dbPosts = [];

    tabSearch.addEventListener('click', () => {
      tabSearch.classList.add('active');
      tabDb.classList.remove('active');
      viewSearch.classList.add('active');
      viewDb.classList.remove('active');
    });

    tabDb.addEventListener('click', () => {
      tabDb.classList.add('active');
      tabSearch.classList.remove('active');
      viewDb.classList.add('active');
      viewSearch.classList.remove('active');
    });

    const showSaveModal = (result) => {
      modalSaved.textContent = result.stored ?? 0;
      modalDupes.textContent = result.duplicates ?? 0;
      modalErrors.textContent = result.errors ?? 0;
      modalDetail.textContent = `Total received: ${result.total_received ?? 0}`;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    };

    const closeSaveModal = () => {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    };

    modalClose.addEventListener('click', closeSaveModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeSaveModal();
    });

    const inferredApiBase = (() => {
      const fromAttr = document.documentElement.dataset.apiBase;
      if (fromAttr && fromAttr !== '%%API_BASE_URL%%') return fromAttr;
      return 'http://localhost:8000';
    })();
    if (!apiBaseInput.value) apiBaseInput.value = inferredApiBase;
    apiBaseCurrent = apiBaseInput.value;

    timeFilter.addEventListener('change', () => {
      const isCustom = timeFilter.value === 'custom';
      customDates.classList.toggle('is-disabled', !isCustom);
      customDates.setAttribute('aria-hidden', String(!isCustom));
      startDate.disabled = !isCustom;
      endDate.disabled = !isCustom;
    });

    const escapeHtml = (str) => {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const formatDate = (value) => {
      if (!value) return 'Unknown';
      try {
        const date = new Date(value);
        return date.toLocaleString([], { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch (err) {
        return value;
      }
    };

    const truncate = (value, limit = 220) => {
      if (!value) return '';
      return value.length > limit ? `${value.slice(0, limit)}...` : value;
    };

    const setStatus = (label, tone = 'idle') => {
      statusChip.textContent = label;
      statusChip.className = `chip ${tone === 'error' ? 'danger' : tone === 'live' ? 'accent' : ''}`;
    };

    const computeStats = (posts) => {
      if (!posts.length) return { avgScore: 0, avgUpvote: 0 };
      const avgScore = posts.reduce((sum, p) => sum + (p.score || 0), 0) / posts.length;
      const avgUpvote = posts.reduce((sum, p) => sum + (p.upvote_ratio || 0), 0) / posts.length;
      return { avgScore, avgUpvote };
    };

    const renderResults = (posts, brand) => {
      resultsTableBody.innerHTML = '';

      if (!posts.length) {
        resultsTableBody.innerHTML = '<tr><td colspan="9" class="empty-row">No posts matched your filters. Try widening the time window or reducing the score threshold.</td></tr>';
        resultsCount.textContent = '0 posts';
        statCount.textContent = '0';
        statScore.textContent = '0';
        statUpvote.textContent = '0%';
        resultsTitle.textContent = 'No matches found';
        resultsSubtitle.textContent = 'Adjust filters and try again.';
        downloadBtn.disabled = true;
        saveBtn.disabled = true;
        return;
      }

      const { avgScore, avgUpvote } = computeStats(posts);
      statCount.textContent = String(posts.length);
      statScore.textContent = avgScore.toFixed(1);
      statUpvote.textContent = `${Math.round(avgUpvote * 100)}%`;
      resultsCount.textContent = `${posts.length} posts`;
      resultsTitle.textContent = `${brand ? brand : 'Your brand'} on Reddit`;
      resultsSubtitle.textContent = 'Sorted by relevance from the scraper backend.';
      downloadBtn.disabled = false;
      saveBtn.disabled = false;

      posts.forEach((post) => {
        const permalink = post.permalink || post.url || '#';
        const row = document.createElement('tr');

        row.innerHTML = `
          <td><span class="chip muted">r/${escapeHtml(post.subreddit || 'unknown')}</span></td>
          <td class="cell-title">${escapeHtml(truncate(post.title || 'Untitled', 100))}</td>
          <td class="cell-body">${escapeHtml(truncate(post.text || post.content || '', 150))}</td>
          <td class="cell-number">${post.score || 0}</td>
          <td class="cell-number">${post.comments || 0}</td>
          <td class="cell-number">${post.upvote_ratio ? Math.round(post.upvote_ratio * 100) + '%' : '0%'}</td>
          <td class="cell-author">${escapeHtml(post.author || 'unknown')}</td>
          <td class="cell-date">${formatDate(post.created_at)}</td>
          <td><a class="link" href="${escapeHtml(permalink)}" target="_blank" rel="noopener noreferrer">View</a></td>
        `;

        resultsTableBody.appendChild(row);
      });
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      feedback.textContent = '';
      saveStatus.textContent = '';

      const formData = new FormData(form);
      const query = formData.get('query');
      if (!query) {
        feedback.textContent = 'Please enter a keyword or brand.';
        return;
      }

      const apiBase = (formData.get('api_base') || inferredApiBase || '').toString().replace(/\/$/, '');
      apiBaseCurrent = apiBase;
      const params = new URLSearchParams();
      params.set('query', query);
      params.set('limit', formData.get('limit') || '30');
      params.set('min_upvotes', formData.get('min_upvotes') || '0');
      const includeSubs = (formData.get('include_subs') || '').split(',').map(s => s.trim()).filter(Boolean);
      const excludeSubs = (formData.get('exclude_subs') || '').split(',').map(s => s.trim()).filter(Boolean);
      const sort = formData.get('sort') || 'relevance';
      const searchScope = formData.get('search_scope') || 'title_body';
      if (includeSubs.length) params.set('include_subreddits', includeSubs.join(','));
      if (excludeSubs.length) params.set('exclude_subreddits', excludeSubs.join(','));
      params.set('sort', sort);
      params.set('search_scope', searchScope);

      const filter = formData.get('time_filter');
      params.set('time_filter', filter || 'week');
      if (filter === 'custom') {
        const start = formData.get('start_date');
        const end = formData.get('end_date');
        if (!start || !end) {
          feedback.textContent = 'Set both start and end dates for a custom window.';
          return;
        }
        params.set('start_date', start);
        params.set('end_date', end);
      }

      const regionOptions = Array.from(document.getElementById('regions').selectedOptions).map((opt) => opt.value);
      const hasAll = regionOptions.includes('All');
      const regions = hasAll ? [] : regionOptions;
      if (regions.length) {
        params.set('regions', regions.join(','));
      }

      const url = `${apiBase || 'http://localhost:8000'}/reddit/search?${params.toString()}`;

      setStatus('Requesting...', 'live');
      feedback.textContent = 'Fetching posts from the API...';
      resultsTable.classList.add('loading');

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }
        const data = await response.json();
        lastPosts = data.posts || [];
        lastBrand = query.toString();
        renderResults(lastPosts, lastBrand);
        feedback.textContent = `Fetched ${data.total || 0} posts.`;
        setStatus('Success', '');
      } catch (err) {
        console.error(err);
        feedback.textContent = `Error: ${err.message}`;
        renderResults([], '');
        setStatus('Error', 'error');
      } finally {
        resultsTable.classList.remove('loading');
      }
    });

    const downloadCsv = () => {
      if (!lastPosts.length) return;
      const headers = [
        'id','title','text','subreddit','author','url','permalink','score','comments','upvote_ratio','created_at'
      ];
      const rows = lastPosts.map(p => [
        p.id || '',
        (p.title || '').replace(/"/g, '""'),
        (p.text || '').replace(/"/g, '""'),
        p.subreddit || '',
        p.author || '',
        p.url || '',
        p.permalink || '',
        p.score ?? '',
        p.comments ?? '',
        p.upvote_ratio ?? '',
        p.created_at || ''
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${lastBrand || 'reddit'}-results.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    downloadBtn.addEventListener('click', downloadCsv);

    saveBtn.addEventListener('click', async () => {
      if (!lastPosts.length) {
        saveStatus.textContent = 'No posts to save. Run a search first.';
        return;
      }
      saveBtn.disabled = true;
      saveStatus.textContent = 'Saving posts to database...';
      try {
        const response = await fetch(`${apiBaseCurrent}/reddit/save`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ posts: lastPosts, brand: lastBrand }),
        });
        if (!response.ok) {
          throw new Error(`Save failed with status ${response.status}`);
        }
        const result = await response.json();
        saveStatus.textContent = `Saved ${result.stored} new, ${result.duplicates} duplicates skipped, ${result.errors} errors.`;
        if (result.errors === 0) {
          setStatus('Saved to DB', '');
          // Clear local results and return user to the top/home view
          lastPosts = [];
          renderResults([], '');
          saveBtn.disabled = true;
          showSaveModal(result);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      } catch (err) {
        console.error(err);
        saveStatus.textContent = `Error saving: ${err.message}`;
      } finally {
        saveBtn.disabled = false;
      }
    });

    dbForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      dbFeedback.textContent = '';
      const formData = new FormData(dbForm);
      const params = new URLSearchParams();
      const brand = formData.get('db-brand');
      const subreddit = formData.get('db-subreddit');
      const limit = formData.get('db-limit') || '50';
      const minScore = formData.get('db-min-score') || '0';

      params.set('limit', limit);
      params.set('min_score', minScore);
      if (brand) params.set('search_brand', brand);
      if (subreddit) params.set('subreddit', subreddit);

      await loadDbPosts(params);
    });

    dbViewAllBtn.addEventListener('click', async () => {
      dbFeedback.textContent = '';
      const params = new URLSearchParams();
      params.set('limit', '200'); // Max limit for viewing all
      params.set('min_score', '0');
      await loadDbPosts(params);
    });

    const loadDbPosts = async (params) => {
      const url = `${apiBaseCurrent}/reddit/posts?${params.toString()}`;
      dbFeedback.textContent = 'Loading posts from database...';
      dbResultsTable.classList.add('loading');

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Request failed with status ${response.status}`);
        }
        const data = await response.json();
        dbPosts = data.posts || [];
        renderDbTable(dbPosts);
        dbFeedback.textContent = `Loaded ${data.total || 0} posts from database.`;
      } catch (err) {
        console.error(err);
        dbFeedback.textContent = `Error: ${err.message}`;
        renderDbTable([]);
      } finally {
        dbResultsTable.classList.remove('loading');
      }
    };

    const renderDbTable = (posts) => {
      dbTableBody.innerHTML = '';
      if (!posts.length) {
        dbTableBody.innerHTML = '<tr><td colspan="9" class="empty-row">No saved posts match your filters.</td></tr>';
        dbResultsCount.textContent = '0 posts';
        dbDownloadBtn.disabled = true;
        return;
      }

      dbResultsCount.textContent = `${posts.length} posts`;
      dbDownloadBtn.disabled = false;

      posts.forEach((post) => {
        const metrics = post.metrics || {};
        const permalink = post.permalink || post.url || '#';
        const row = document.createElement('tr');

        row.innerHTML = `
          <td><span class="chip muted">r/${escapeHtml(post.subreddit || 'unknown')}</span></td>
          <td class="cell-title">${escapeHtml(truncate(post.title || 'Untitled', 100))}</td>
          <td class="cell-body">${escapeHtml(truncate(post.content || '', 150))}</td>
          <td class="cell-number">${metrics.score || 0}</td>
          <td class="cell-number">${metrics.comments || 0}</td>
          <td class="cell-number">${metrics.upvote_ratio ? Math.round(metrics.upvote_ratio * 100) + '%' : '0%'}</td>
          <td class="cell-author">${escapeHtml(post.author || 'unknown')}</td>
          <td class="cell-date">${formatDate(post.created_at)}</td>
          <td><a class="link" href="${escapeHtml(permalink)}" target="_blank" rel="noopener noreferrer">View</a></td>
        `;

        dbTableBody.appendChild(row);
      });
    };

    const downloadDbCsv = () => {
      if (!dbPosts.length) return;
      const headers = [
        'id','title','content','subreddit','author','url','permalink','score','comments','upvote_ratio','created_at','scraped_at'
      ];
      const rows = dbPosts.map(p => {
        const m = p.metrics || {};
        return [
          p.id || '',
          (p.title || '').replace(/"/g, '""'),
          (p.content || '').replace(/"/g, '""'),
          p.subreddit || '',
          p.author || '',
          p.url || '',
          p.permalink || '',
          m.score ?? '',
          m.comments ?? '',
          m.upvote_ratio ?? '',
          p.created_at || '',
          p.scraped_at || ''
        ];
      });
      const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'reddit-db-results.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    dbDownloadBtn.addEventListener('click', downloadDbCsv);
  </script>
</body>
</html>
